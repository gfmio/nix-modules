# yaml-language-server: $schema=https://taskfile.dev/schema.json
# Taskfile for health checks
# Learn more: https://taskfile.dev

version: '3'

tasks:
  health:
    desc: Run health checks on the development environment
    cmds:
      - echo "ğŸ¥ Running health checks..."
      - echo ""
      - task: health:nix
      - task: health:direnv
      - task: health:tools
      - task: health:platform
      - echo ""
      - echo "âœ… Health check complete!"

  health:nix:
    desc: Check Nix installation
    cmds:
      - echo "ğŸ“¦ Nix:"
      - task: nix:setup:check
      - nix --version
      - echo ""

  health:direnv:
    desc: Check direnv setup
    cmds:
      - echo "ğŸ”§ Direnv:"
      - task: direnv:setup:check
      - echo ""

  health:tools:
    desc: Check development tools
    cmds:
      - echo "ğŸ› ï¸  Development Tools:"
      - |
        if command -v statix &> /dev/null; then
          echo "  âœ“ statix is available"
        else
          echo "  âš ï¸  statix not found (install with 'nix develop')"
        fi
      - |
        if command -v deadnix &> /dev/null; then
          echo "  âœ“ deadnix is available"
        else
          echo "  âš ï¸  deadnix not found (install with 'nix develop')"
        fi
      - |
        if command -v nixpkgs-fmt &> /dev/null; then
          echo "  âœ“ nixpkgs-fmt is available"
        else
          echo "  âš ï¸  nixpkgs-fmt not found (install with 'nix develop')"
        fi
      - echo ""

  health:platform:
    desc: Check platform-specific tools
    cmds:
      - echo "ğŸ–¥ï¸  Platform:"
      - |
        echo "  System: $(uname -s) $(uname -m)"
      - |
        if [ "$(uname)" = "Darwin" ]; then
          if command -v darwin-rebuild &> /dev/null; then
            echo "  âœ“ darwin-rebuild is available"
          else
            echo "  âš ï¸  darwin-rebuild not found"
          fi
          if command -v tart &> /dev/null; then
            echo "  âœ“ tart is available"
          else
            echo "  â„¹ï¸  tart not available (optional - for VM testing)"
          fi
        fi
      - |
        if [ "$(uname)" = "Linux" ]; then
          if command -v nixos-rebuild &> /dev/null; then
            echo "  âœ“ nixos-rebuild is available"
          else
            echo "  â„¹ï¸  nixos-rebuild not available (only needed on NixOS)"
          fi
        fi
      - |
        if command -v home-manager &> /dev/null; then
          echo "  âœ“ home-manager is available"
        else
          echo "  â„¹ï¸  home-manager not available (optional)"
        fi
      - echo ""

  health:flake:
    desc: Check flake health
    sources:
      - 'flake.nix'
      - 'flake.lock'
    cmds:
      - echo "ğŸ“¦ Flake Health:"
      - |
        if nix flake metadata --json > /dev/null 2>&1; then
          echo "  âœ“ Flake metadata is valid"
        else
          echo "  âŒ Flake metadata is invalid"
          exit 1
        fi
      - |
        if nix flake show > /dev/null 2>&1; then
          echo "  âœ“ Flake outputs are valid"
        else
          echo "  âŒ Flake outputs are invalid"
          exit 1
        fi
      - echo "âœ… Flake is healthy!"

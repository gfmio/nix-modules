# yaml-language-server: $schema=https://taskfile.dev/schema.json
# Taskfile for all nix tasks
# Learn more: https://taskfile.dev

version: '3'

tasks:
  nix:setup:check:
    desc: Check if nix is available
    cmds:
      - |
        if ! command -v nix &> /dev/null; then
          echo "‚ö†Ô∏è nix not found. Install it by following the instructions for your platform."
          exit 1
        fi

  # Build tasks

  nix:build:nixos:my-nixos-box:
    desc: Build my-nixos-box NixOS configuration
    cmds:
      - echo "üèóÔ∏è  Building my-nixos-box NixOS configuration..."
      - nix build .#nixosConfigurations.my-nixos-box.config.system.build.toplevel -L
      - echo "‚úÖ my-nixos-box NixOS configuration built!"

  nix:build:nixos:*:
    desc: Build a NixOS configuration
    vars:
      NAME: '{{index .MATCH 0}}'
    cmds:
      - echo "üèóÔ∏è  Building {{.NAME}} NixOS configuration..."
      - nix build .#nixosConfigurations.{{.NAME}}.config.system.build.toplevel -L
      - echo "‚úÖ {{.NAME}} NixOS configuration built!"

  nix:build:nixos:
    desc: Build all NixOS configurations
    cmds:
      - echo "üèóÔ∏è  Building all NixOS configurations..."
      - task: nix:build:nixos:my-nixos-box
      - echo "‚úÖ All NixOS configurations built!"

  nix:build:darwin:my-mac:
    desc: Build my-mac nix-darwin configuration
    platforms: [darwin]
    cmds:
      - echo "üèóÔ∏è  Building my-mac nix-darwin configuration..."
      - nix build .#darwinConfigurations.my-mac.config.system.build.toplevel -L
      - echo "‚úÖ my-mac nix-darwin configuration built!"

  nix:build:darwin:*:
    desc: Build a nix-darwin configuration
    platforms: [darwin]
    vars:
      NAME: '{{index .MATCH 0}}'
    cmds:
      - echo "üèóÔ∏è  Building {{.NAME}} nix-darwin configuration..."
      - nix build .#darwinConfigurations.{{.NAME}}.config.system.build.toplevel -L
      - echo "‚úÖ {{.NAME}} nix-darwin configuration built!"

  nix:build:darwin:
    desc: Build all nix-darwin configurations
    platforms: [darwin]
    cmds:
      - echo "üèóÔ∏è  Building all nix-darwin configurations..."
      - task: nix:build:darwin:my-mac
      - echo "‚úÖ All nix-darwin configurations built!"

  nix:build:all:
    desc: Build all configurations
    aliases:
      - nix:build
    cmds:
      - echo "üèóÔ∏è  Building all configurations..."
      - task: build:darwin
      - task: build:nixos
      - echo "‚úÖ All configurations built!"

  # Development tasks

  nix:develop:
    desc: Enter the default development shell
    interactive: true
    cmds:
      - nix develop

  nix:develop:nix:
    desc: Enter the Nix development shell
    interactive: true
    cmds:
      - nix develop .#nix

  nix:repl:
    desc: Open Nix REPL with flake loaded
    interactive: true
    cmds:
      - nix repl --expr 'builtins.getFlake "{{.TASKFILE_DIR}}"'

  # Testing tasks

  nix:test:
    desc: Run all nix tests
    cmds:
      - task: nix:flake:check

  # Unit tests

  nix:test:unit:
    desc: Run all nix unit tests
    cmds:
      - task: nix:test:unit:nixos
      - task: nix:test:unit:darwin

  nix:test:unit:nixos:
    desc: Run all NixOS unit tests
    cmds:
      - echo "üß™ Running NixOS unit tests..."
      - nix build .#checks.x86_64-linux.eval-test -L
      - echo "‚úÖ NixOS unit tests passed!"

  nix:test:unit:darwin:
    desc: Run all nix-darwin unit tests
    platforms: [darwin]
    cmds:
      - echo "üß™ Running nix-darwin unit tests..."
      - nix build .#checks.aarch64-darwin.darwin-eval-test -L
      - echo "‚úÖ nix-darwin unit tests passed!"

  # Integration tests

  nix:test:integration:
    desc: Run all nix integration tests
    cmds:
      - task: nix:test:integration:nixos
      - task: nix:test:integration:darwin

  nix:test:integration:nixos:
    desc: Run all NixOS integration tests
    cmds:
      - echo "üß™ Running NixOS integration tests..."
      - nix build .#checks.x86_64-linux.nixos-integration -L
      - echo "‚úÖ NixOS integration tests passed!"

  nix:test:integration:darwin:
    desc: Run all nix-darwin integration tests
    platforms: [darwin]
    cmds:
      - echo "üß™ Running nix-darwin integration tests..."
      - nix build .#checks.aarch64-darwin.darwin-integration -L
      - echo "‚úÖ nix-darwin integration tests passed!"

  # VM tests

  nix:test:vm:
    desc: Run all VM tests
    cmds:
      - task: nix:test:vm:nixos
      - task: nix:test:vm:darwin

  nix:test:vm:darwin:
    desc: Run nix-darwin VM tests with tart
    platforms: [darwin]
    cmds:
      - echo "üß™ Running darwin VM tests..."
      - ./tests/integration/darwin-vm-test.sh
      - echo "‚úÖ Darwin VM tests passed!"

  nix:test:vm:nixos:
    desc: Build all NixOS VM test configurations
    cmds:
      - echo "üß™ Building NixOS VM tests..."
      - task: nix:test:vm:nixos:desktop
      - task: nix:test:vm:nixos:server
      - echo "‚úÖ All NixOS VM tests built!"

  nix:test:vm:nixos:desktop:
    desc: Run NixOS desktop VM tests
    platforms: [linux]
    cmds:
      - echo "üñ•Ô∏è  Building NixOS desktop VM test..."
      - nix build .#nixosConfigurations.desktop-vm.config.system.build.vm -L
      - echo "‚úÖ NixOS desktop VM test passed!"

  nix:test:vm:nixos:server:
    desc: Run NixOS server VM tests
    platforms: [linux]
    cmds:
      - echo "üñ•Ô∏è  Building NixOS server VM test..."
      - nix build .#nixosConfigurations.server-vm.config.system.build.vm -L
      - echo "‚úÖ NixOS server VM test passed!"

  # Linting tasks

  nix:lint:check:
    desc: Lint all nix files with all available nix linters
    aliases:
      - nix:lint
    cmds:
      - task: statix:lint:check
      - task: deadnix:lint:check

  # Formatting tasks

  nix:fmt:
    desc: Format all Nix files
    aliases:
      - nix:format
      - nix:format:apply
    cmds:
      - echo "üìù Formatting Nix files..."
      - nix fmt
      - echo "‚úÖ Formatting complete!"

  nix:fmt:check:
    desc: Check formatting of all nix files
    aliases:
      - nix:format:check
    cmds:
      - echo "üîç Checking code formatting..."
      - nixpkgs-fmt --check .

  # Flake check tasks

  nix:flake:check:
    desc: Run all checks with nix flake check
    aliases:
      - flake:check
    cmds:
      - nix flake check

  nix:flake:check:format:
    desc: Check code formatting
    cmds:
      - echo "üß™ Checking formatting..."
      - nix build .#checks.x86_64-linux.formatting -L
      - echo "‚úÖ Formatting check passed!"

  nix:flake:check:statix:
    desc: Check with statix linter
    cmds:
      - echo "üß™ Checking with statix..."
      - nix build .#checks.x86_64-linux.statix -L
      - echo "‚úÖ Statix check passed!"

  nix:flake:check:deadnix:
    desc: Check for dead code with deadnix
    cmds:
      - echo "üß™ Checking for dead code..."
      - nix build .#checks.x86_64-linux.deadnix -L
      - echo "‚úÖ Dead code check passed!"

  nix:flake:check:eval:
    desc: Check module evaluation
    cmds:
      - echo "üß™ Checking module evaluation..."
      - nix build .#checks.x86_64-linux.nixos-modules-evaluate -L
      - echo "‚úÖ Module evaluation check passed!"

  # Performance testing

  nix:test:perf:
    desc: Measure nix evaluation performance
    aliases:
      - nix:perf
    cmds:
      - echo "‚ö° Measuring evaluation performance..."
      - |
        for config in desktop laptop server; do
          echo "Testing $config configuration..."
          START=$(date +%s%N)
          nix eval .#nixosConfigurations.$config.config.system.build.toplevel.drvPath >/dev/null 2>&1
          END=$(date +%s%N)
          DURATION=$((($END - $START) / 1000000))
          echo "  ‚è±Ô∏è  $config: ${DURATION}ms"
          if [ $DURATION -gt 5000 ]; then
            echo "  ‚ö†Ô∏è  Warning: Evaluation took more than 5 seconds"
          fi
        done
      - echo "‚úÖ Performance test complete!"

  # Cleanup tasks

  nix:clean:result:
    desc: Clean nix build artifacts
    aliases:
      - nix:clean
    cmds:
      - echo "üßπ Cleaning build artifacts..."
      - rm -rf result result-*
      - echo "‚úÖ Build artifacts cleaned!"

  nix:clean:store:
    desc: Clean Nix store (careful!)
    prompt: This will remove all unused packages from the Nix store. Continue?
    cmds:
      - echo "üßπ Cleaning Nix store..."
      - nix-collect-garbage -d
      - echo "‚úÖ Nix store cleaned!"

  # Flake management tasks

  # Flake update tasks

  nix:flake:update:all:
    desc: Update all flake inputs
    aliases:
      - nix:flake:update
      - flake:update:all
      - flake:update
    cmds:
      - echo "‚¨ÜÔ∏è  Updating flake inputs..."
      - nix flake update
      - echo "‚úÖ Inputs updated!"

  nix:flake:update:input:
    desc: "Update a specific input (usage: task update-input -- nixpkgs)"
    aliases:
      - flake:update:input
    cmds:
      - echo "‚¨ÜÔ∏è  Updating {{.CLI_ARGS}}..."
      - nix flake lock --update-input {{.CLI_ARGS}}

  nix:flake:update:check:
    desc: Check for updates to flake inputs
    aliases:
      - flake:update:check
    cmds:
      - echo "üîç Checking for updates..."
      - nix flake lock --recreate-lock-file --commit-lock-file 2>&1 | grep -E "(Updated|warning)" || echo "‚úÖ All inputs are up to date"

  # Information tasks

  nix:flake:info:
    desc: Show flake information
    aliases:
      - flake:info
      - info
    cmds:
      # - echo "‚ÑπÔ∏è  Flake information:"
      - task: nix:flake:show
      # - echo ""
      # - echo "üì¶ Flake metadata:"
      - task: nix:flake:metadata

  nix:flake:show:
    desc: Show flake outputs
    aliases:
      - flake:show
    cmds:
      - nix flake show

  nix:flake:metadata:
    desc: Show flake metadata
    aliases:
      - flake:metadata
    cmds:
      - nix flake metadata

  nix:flake:graph:
    desc: Show dependency graph of flake inputs
    cmds:
      - 'nix flake metadata --json | jq -r ''.locks.nodes | to_entries | .[] | "\(.key): \(.value.locked.type):\(.value.locked.owner // "")/\(.value.locked.repo // .value.locked.url // "")"'''

  nix:tree:
    desc: Show dependency tree
    cmds:
      - echo "üå≥ Dependency tree:"
      - nix-tree

  # VM tasks

  vm:nixos:desktop:
    desc: Build and run NixOS desktop VM
    platforms: [linux]
    cmds:
      - echo "üñ•Ô∏è  Building desktop VM..."
      - nix build .#nixosConfigurations.desktop-vm.config.system.build.vm -L
      - echo "üöÄ Starting desktop VM..."
      - echo "‚ÑπÔ∏è  Use Ctrl+Alt+2 for QEMU monitor, Ctrl+Alt+1 to return to VM"
      - echo "‚ÑπÔ∏è  Press Ctrl+C to stop the VM"
      - ./result/bin/run-desktop-vm

  vm:nixos:server:
    desc: Build and run NixOS server VM
    platforms: [linux]
    cmds:
      - echo "üñ•Ô∏è  Building server VM..."
      - nix build .#nixosConfigurations.server-vm.config.system.build.vm -L
      - echo "üöÄ Starting server VM..."
      - echo "‚ÑπÔ∏è  SSH will be available on port 2222 - ssh -p 2222 testuser@localhost"
      - 'QEMU_OPTS="-netdev user,id=net0,hostfwd=tcp::2222-:22" ./result/bin/run-server-vm'

  vm:nixos:desktop:kvm:
    desc: Run desktop VM with KVM acceleration
    platforms: [linux]
    cmds:
      - echo "üñ•Ô∏è  Building desktop VM with KVM..."
      - nix build .#nixosConfigurations.desktop-vm.config.system.build.vm -L
      - echo "üöÄ Starting desktop VM with KVM acceleration..."
      - QEMU_OPTS="-enable-kvm -m 4096" ./result/bin/run-desktop-vm

  vm:nixos:desktop:interactive:
    desc: "Run VM with custom QEMU options (usage: task vm:nixos:desktop:interactive -- -m 4096)"
    platforms: [linux]
    cmds:
      - echo "üñ•Ô∏è  Building VM..."
      - nix build .#nixosConfigurations.desktop-vm.config.system.build.vm -L
      - echo "üöÄ Starting VM with custom options..."
      - 'QEMU_OPTS="{{.CLI_ARGS}}" ./result/bin/run-desktop-vm'
